extends layout

block content
  img(src="#{user.picture}")
  h2 Welcome #{user.nickname}!
  p#auth0UserJwt #{user.id_token}
  br
  p.nickname
  p#boxId #{user.app_metadata.boxId}
  p#accessToken #{user.boxAccessTokenObject.accessToken}
  p#expiresAt #{user.boxAccessTokenObject.expiresAt}
  a(href='/logout') Logout
  script(src="https://cdn.auth0.com/js/lock-9.0.js")
  script(src="https://code.jquery.com/jquery-2.2.4.min.js")
  script(src="./javascripts/Box.Client.js")
  //- script(src="./javascripts/main.js")
  script.
    var BoxApp = {
      boxId: '#{user.app_metadata.boxId}',
      auth0UserJwt: '#{user.id_token}',
      boxAccessTokenObject: {'accessToken': '#{user.boxAccessTokenObject.accessToken}', 'expiresAt': '#{user.boxAccessTokenObject.expiresAt}'},
      refreshCallbackUrl: '#{boxAccessTokenRefreshUrl}',
      refreshBoxUserTokenCallback: function(err, success) {
        console.log("REFRESHING ACCESS TOKEN WITH CALLBACK!!!!");
        $.ajax({
          method: 'POST',
          url: BoxApp.refreshCallbackUrl,
          headers: {
            "Authorization": "Bearer #{user.id_token}"
          },
          data: {boxId: BoxApp.boxId}
        })
        .fail(err("Something went wrong..."))
        .done(success);
      },
      setBoxId: function(callback) {
        var me = this;
        var lock = new Auth0Lock('#{env.AUTH0_CLIENT_ID}', '#{env.AUTH0_DOMAIN}');
        lock.getProfile("#{user.id_token}", function (err, profile) {
          if (err) {
            return alert('There was an error getting the profile: ' + err.message);
          }
          me.boxId = profile.app_metadata.boxId;
          callback();
        });
      }
    };
  script.
    var boxClient = new Box.client(BoxApp.boxAccessTokenObject, BoxApp.refreshBoxUserTokenCallback);
    console.log(boxClient);
    boxClient.folders.get('0', null, function(err, body) {
      if(err) {
        console.log("Error detected");
        console.log(err);
      }
      console.log(body);
    });